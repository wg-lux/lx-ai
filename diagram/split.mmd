flowchart TD

    A[Load Dataset IDs from Config]

    A --> |Fetch Frames from Database|C{Does </br> old_examination_id </br> exist?}

    C -->|Yes| D[Use old_examination_id </br> as hash key]
    C -->|No| E[Fallback to frame_id </br> as hash key]

    D --> F[Compute Stable Hash Key]
    E --> F

    F --> G[Compute bucket_id = hash % num_buckets]

    G --> H{Bucket Policy Check}

    H -->|bucket_id in validation_buckets| I[Assign to Validation Split]
    H -->|bucket_id in test_buckets| J[Assign to Test Split]
    H -->|Otherwise| K[Assign to Training Split]

    I --> L[Collect val_indices]
    J --> M[Collect test_indices]
    K --> N[Collect train_indices]

    L --> O[Return Split Indices]
    M --> O
    N --> O

    O --> P[Optional: Save Bucket Snapshot]

    P --> Q[Save all_bucket_assignments.json]
    P --> R[Save run_metadata.json]